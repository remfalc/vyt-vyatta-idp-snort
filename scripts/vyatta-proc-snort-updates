#!/bin/bash
#
# Module: vyatta-proc-snort-updates
# 
# **** License ****
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License version 2 as
# published by the Free Software Foundation.
# 
# This program is distributed in the hope that it will be useful, but
# WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
# General Public License for more details.
# 
# This code was originally developed by Vyatta, Inc.
# Portions created by Vyatta are Copyright (C) 2008-2010 Vyatta, Inc.
# All Rights Reserved.
# 
# Author: An-Cheng Huang
# Date: May 2008
# Description: process snort update
# 
# **** End License ****
#

NEW_SNORT_UPDATE_FILE=$1

BASE_DIR='/opt/vyatta/etc/ips'
WORK_DIR="$BASE_DIR/work"
BACKUP_DIR="$BASE_DIR/backup"
LOG_FILE="$BASE_DIR/update.log"
SNORT_UPDATE_FILE='snortrules-snapshot-2.8.tar'
CUR_TIME=$(date +%F-%H%M%S)
LAST_UPDATE_STATUS_FILE="$BASE_DIR/lastupdatestatus"

# when invoked from cron, we don't have these variables
export VYATTA_EDIT_LEVEL='/'
export VYATTA_TEMPLATE_LEVEL='/'
export VYATTA_ACTIVE_CONFIGURATION_DIR='/opt/vyatta/config/active'

log_message ()
{
  echo "$CUR_TIME: $*" >> $LOG_FILE
}

abort_updates ()
{
  log_message "$*"
  log_message 'Update aborted due to error. IPS rules not updated.'
  echo update failed at `date` > $LAST_UPDATE_STATUS_FILE
  rm -f $BASE_DIR/SNORT_UPDATE_FILE.gz
  rm -f $WORK_DIR/SNORT_UPDATE_FILE
  exit 1
}

if [ ! -f $NEW_SNORT_UPDATE_FILE ]; then
  log_message 'Update file missing.'
  exit 1
fi

file_type=$(file -ib $NEW_SNORT_UPDATE_FILE)
if [ "$file_type" != "application/x-gzip" ]; then
  log_message "Invalid file type [$file_type]."
  exit 1
fi

mkdir -p $BASE_DIR
cd $BASE_DIR

# clean up work dir
rm -rf $WORK_DIR
mkdir -p $WORK_DIR

mv $NEW_SNORT_UPDATE_FILE $BASE_DIR/$SNORT_UPDATE_FILE.gz

cd $WORK_DIR
cp ../$SNORT_UPDATE_FILE.gz . >&/dev/null

# sanity check
if [ ! -r $WORK_DIR/$SNORT_UPDATE_FILE.gz ]; then
  abort_updates "Failed to get $SNORT_UPDATE_FILE.gz"
fi

# extract
gunzip $SNORT_UPDATE_FILE.gz >&/dev/null

file_type=$(file -ib $SNORT_UPDATE_FILE)
if [ "$file_type" != "application/x-tar" ]; then
  log_message "Invalid file type [$file_type]."
  exit 1
fi

tar xf $SNORT_UPDATE_FILE >&/dev/null

# now we have the following directories
#   doc: not using
#   so_rules: not using
#   etc: replaces /etc/snort
#   rules: replaces /etc/snort/rules
if [ ! -d etc -o ! -d rules ]; then
  abort_updates 'Invalid update file'
fi

# process etc/
(
  cd etc
  # generate ips.conf from new snort.conf
  sed '/^var RULE_PATH / {
         s/\(var RULE_PATH \).*$/\1\/etc\/snort\/rules/
         a\
\n### NOTE: Lines between the BEGIN and END markers below are generated\
###       automatically. Do NOT modify by hand.\
# === BEGIN VYATTA SNORT CONFIG ===\
# === END VYATTA SNORT CONFIG ===
       }' snort.conf > ips.conf

  if [ ! -f ips.conf ]; then
    abort_updates 'Cannot generate ips.conf'
  fi

  if ! grep -q 'BEGIN VYATTA SNORT CONFIG' ips.conf; then
    abort_updates 'Cannot generate ips.conf'
  fi

  # copy the vyatta section from the old ips.conf
  sed -n '1,/^# === BEGIN VYATTA SNORT CONFIG ===/p' ips.conf > ips.conf.new
  sed -n '1,/^# === BEGIN VYATTA SNORT CONFIG ===/d
          /^# === END VYATTA SNORT CONFIG ===/,$d
          p' /etc/snort/ips.conf >> ips.conf.new
  sed -n '/^# === END VYATTA SNORT CONFIG ===/,$p' ips.conf >> ips.conf.new
  mv ips.conf.new ips.conf

  # correct library path
  sed -i 's/\/usr\/local\/lib/\/usr\/lib/' ips.conf

  # comment out dynamicdetection 
  sed -i s/^dynamicdetection/#dynamicdetection/ ips.conf

  # generate snort.conf from ips.conf
  cp -f ips.conf snort.conf

  # sanity check
  if ! grep -q '^ruletype p1action' snort.conf; then
    abort_updates 'Cannot generate ips.conf'
  fi

  # get the missing files
  if ! cp /etc/snort/{antivirus.conf,clamav.config,snort.debian.conf} .; then
    abort_updates 'Original config file missing'
  fi
)

# process rules/
if ! /opt/vyatta/sbin/vyatta-proc-snort-rules.pl \
        --classfile ./etc/classification.config \
        --ruledir ./rules --outdir ./rules-new; then
  abort_updates 'Cannot process downloaded rules'
fi

# copy any local rules
cp -f /etc/snort/rules/local.rules rules-new

# any other checks before committing to the updates

# move /etc/snort to backup
mkdir -p $BACKUP_DIR
if ! mv /etc/snort $BACKUP_DIR/snort.$CUR_TIME >&/dev/null; then
  abort_updates 'Failed to move /etc/snort'
fi

# workaround possible unionfs bug where the previous mv does
# not create a white-out file
rm -rf /etc/snort

# move etc to /etc/snort
if ! mv etc /etc/snort >&/dev/null; then
  abort_updates 'Failed to move etc'
fi

# move rules-new to /etc/snort/rules
if ! mv rules-new /etc/snort/rules >&/dev/null; then
  abort_updates 'Failed to move rules'
fi

# 'snort -T' check.
# if it fails, restore the directories and abort
if ! /etc/init.d/snort config-check >&/dev/null; then
  rm -rf /etc/snort
  mv $BACKUP_DIR/snort.$CUR_TIME /etc/snort >&/dev/null
  abort_updates 'Final rule check failed'
fi

# finally, restart snort
/opt/vyatta/sbin/vyatta-update-inspection.pl 3 0 orig_only

echo update succeeded at `date` > $LAST_UPDATE_STATUS_FILE
log_message 'IPS rules update completed successfully'
log_message "Original rules are moved to $BACKUP_DIR/snort.$CUR_TIME"
rm -rf $WORK_DIR
exit 0

